sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","com/apptech/realestate/controller/AppUI5"],function(e,t,o,i,d,s){"use strict";return e.extend("com.apptech.realestate.controller.TaxMatrix",{onRoutePatternMatched:function(e){this.getView().addStyleClass(this.getOwnerComponent().getContentDensityClass());this.prepareTable(false)},onInit:function(){var e=this.getOwnerComponent().getRouter().getRoute("TaxMatrix");e.attachPatternMatched(this.onRoutePatternMatched,this);this.bIsAdd=true;this.tableId="tblTax";this.getView().addStyleClass(this.getOwnerComponent().getContentDensityClass());this.aCols=[];this.columnData=[];this.oEditRecord={};this.iRecordCount=0;this.oIconTab=this.getView().byId("tab1");this.oIconTab2=this.getView().byId("tab2");this.recordCode="";this.oMdlAllRecord=new t;this.oMdlEditRecord=new t("model/TaxMatrix.json");this.getView().setModel(this.oMdlEditRecord,"oMdlEditRecord");this.oMdlAllBuildType=new sap.ui.model.json.JSONModel;$.ajax({url:"/rexsjs/public/rexsjs/ExecQuery.xsjs?dbName=APP_RE&procName=SPAPP_RE_GETAXMATRIXDATA&keyCode=&queryType=GetBuildType",type:"GET",xhrFields:{withCredentials:true},error:function(e,t,i){o.show(i)},success:function(e){},context:this}).done(function(e){if(e){this.oMdlAllBuildType.setJSON('{"allbuildtype" : '+JSON.stringify(e)+"}");this.getView().setModel(this.oMdlAllBuildType,"oMdlAllBuildType")}});this.oMdlBuildTypes=new t;$.ajax({url:"/rexsjs/public/rexsjs/ExecQuery.xsjs?dbName=APP_RE&procName=SPAPP_RE_GETAXMATRIXDATA&keyCode=&queryType=GetBuildType",type:"GET",xhrFields:{withCredentials:true},error:function(e,t,i){o.show(i)},success:function(e){},context:this}).done(function(e){if(e){this.oMdlBuildTypes.setJSON('{"allbuildtypes" : '+JSON.stringify(e)+"}");this.getView().setModel(this.oMdlBuildTypes,"oMdlBuildTypes")}});this.prepareTable(true)},prepareTable:function(e){$.ajax({url:"/rexsjs/public/rexsjs/ExecQuery.xsjs?dbName=APP_RE&procName=SPAPP_RE_GETAXMATRIXDATA&keyCode=&queryType=GetAllTaxData",type:"GET",xhrFields:{withCredentials:true},error:function(e,t,i){o.show(i)},success:function(e){},context:this}).done(function(t){if(t){this.aCols=Object.keys(t[0]);var o;this.iRecordCount=t.length;this.oIconTab.setCount(this.iRecordCount);if(e){for(o=0;o<this.aCols.length;o++){this.columnData.push({columnName:this.aCols[o]})}}this.oMdlAllRecord.setData({rows:t,columns:this.columnData});if(e){this.oTable=this.getView().byId(this.tableId);this.oTable.setModel(this.oMdlAllRecord);this.oTable.bindColumns("/columns",function(e,t){var o=t.getObject().columnName;return new sap.ui.table.Column({label:o,template:new sap.m.Text({text:"{"+o+"}"})})});this.oTable.bindRows("/rows");this.oTable.setSelectionMode("Single");this.oTable.setSelectionBehavior("Row");this.renameColumns()}}})},renameColumns:function(){this.oTable.getColumns()[0].setVisible(false);this.oTable.getColumns()[1].setLabel("Tax Code");this.oTable.getColumns()[1].setFilterProperty("TaxCode");this.oTable.getColumns()[2].setLabel("Tax Name");this.oTable.getColumns()[2].setFilterProperty("TaxDesc");this.oTable.getColumns()[3].setLabel("Build Type");this.oTable.getColumns()[4].setLabel("Rate");this.oTable.getColumns()[5].setLabel("Create Date");this.oTable.getColumns()[6].setLabel("Remarks")},onAdd:function(e){this.oMdlEditRecord.getData().EditRecord.TaxCode="";this.oMdlEditRecord.getData().EditRecord.BuildTypeCode="";this.oMdlEditRecord.getData().EditRecord.AmountLimitFrom="";this.oMdlEditRecord.getData().EditRecord.AmountLimitTo="";this.oMdlEditRecord.getData().EditRecord.TaxDesc="";this.oMdlEditRecord.getData().EditRecord.Rate="";this.oMdlEditRecord.getData().EditRecord.Remarks="";this.oMdlEditRecord.getData().EditRecord.ValidDateFrom="";this.oMdlEditRecord.getData().EditRecord.ValidDateTo="";this.oMdlEditRecord.refresh();this.getView().byId("idIconTabBarInlineMode").getItems()[1].setText("RECORD [ADD]");var t=this.getView().byId("idIconTabBarInlineMode");t.setSelectedKey("tab2");this.bIsAdd=true},onEdit:function(e){var t=this.oTable.getSelectedIndex();var i="TaxGetData";var d="";if(t!==-1){var s=this.oTable.getBinding().getModel().getData().rows[this.oTable.getBinding().aIndices[t]];d=s.Code;$.ajax({url:"/rexsjs/public/rexsjs/ExecQuery.xsjs?dbName=APP_RE&procName=SPAPP_RE_GETAXMATRIXDATA&keyCode="+d+"&queryType="+i,type:"GET",xhrFields:{withCredentials:true},error:function(e,t,i){o.show(i)},success:function(e){},context:this}).done(function(e){if(e.length<=0){return}var t=JSON.stringify(e).replace("[","").replace("]","");this.oMdlEditRecord.setJSON('{"EditRecord" : '+t+"}");this.getView().setModel(this.oMdlEditRecord,"oMdlEditRecord");this.getView().byId("idIconTabBarInlineMode").getItems()[1].setText("Record Code : "+this.oMdlEditRecord.getData().EditRecord.TaxCode+" [EDIT]")})}this.recordCode=d;var a=this.getView().byId("idIconTabBarInlineMode");a.setSelectedKey("tab2");this.bIsAdd=false},onSave:function(e){if(this.bIsAdd){var t=s.generateUDTCode();var i="";$.ajax({url:"/rexsjs/public/rexsjs/ExecQuery.xsjs?dbName=APP_RE&procName=SPAPP_RE_GENERATETAX",type:"GET",async:false,xhrFields:{withCredentials:true},error:function(e,t,o){jQuery.sap.log.error("This should never have happened!")},success:function(e){i=e[0].Code},context:this}).done(function(e){if(e){i=e[0].Code}});var d={};d.M_TAX_MATRIX=[];var a={};a.O="I";a.Code=t;a.TaxCode=i;a.TaxDesc=this.oMdlEditRecord.getData().EditRecord.TaxDesc;a.BuildTypeCode=this.oMdlEditRecord.getData().EditRecord.BuildTypeCode;a.AmountLimitFrom=this.oMdlEditRecord.getData().EditRecord.AmountLimitFrom;a.AmountLimitTo=this.oMdlEditRecord.getData().EditRecord.AmountLimitTo;a.Rate=this.oMdlEditRecord.getData().EditRecord.Rate;a.Remarks=this.oMdlEditRecord.getData().EditRecord.Remarks;a.ValidDateFrom=s.getDatePostingFormat(this.oMdlEditRecord.getData().EditRecord.ValidDateFrom);a.ValidDateTo=s.getDatePostingFormat(this.oMdlEditRecord.getData().EditRecord.ValidDateTo);d.M_TAX_MATRIX.push(a);var r=s.postData(d);if(r===0){o.show("Saved Successfully")}else{o.show("Error")}}else{d={};d.M_TAX_MATRIX=[];a={};a.O="U";a.Code=this.oMdlEditRecord.getData().EditRecord.Code;a.TaxCode=this.oMdlEditRecord.getData().EditRecord.TaxCode;a.TaxDesc=this.oMdlEditRecord.getData().EditRecord.TaxDesc;a.BuildTypeCode=this.oMdlEditRecord.getData().EditRecord.BuildTypeCode;a.AmountLimitFrom=this.oMdlEditRecord.getData().EditRecord.AmountLimitFrom;a.AmountLimitTo=this.oMdlEditRecord.getData().EditRecord.AmountLimitTo;a.Rate=this.oMdlEditRecord.getData().EditRecord.Rate;a.Remarks=this.oMdlEditRecord.getData().EditRecord.Remarks;a.ValidDateFrom=s.getDatePostingFormat(this.oMdlEditRecord.getData().EditRecord.ValidDateFrom);a.ValidDateTo=s.getDatePostingFormat(this.oMdlEditRecord.getData().EditRecord.ValidDateTo);d.M_TAX_MATRIX.push(a);r=s.postData(d);if(r===0){o.show("Successfully Updated "+this.oMdlEditRecord.getData().EditRecord.TaxCode)}else{o.show(r.Cause)}}this.prepareTable(false)}})});