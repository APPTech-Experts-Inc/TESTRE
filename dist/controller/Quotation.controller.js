sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","com/apptech/realestate/controller/AppUI5","sap/ui/core/Fragment","sap/m/Dialog","sap/m/ButtonType","sap/m/Button","sap/m/Text","sap/m/MessageBox"],function(t,e,i,o,a,r,d,s,n,c,l,g){"use strict";return t.extend("com.apptech.realestate.controller.Quotation",{onRoutePatternMatched:function(t){document.title="Real Estate - Quotation"},onInit:function(){var t=this.getOwnerComponent().getRouter().getRoute("Quotation");t.attachPatternMatched(this.onRoutePatternMatched,this);this.bIsAdd="0";this.getView().addStyleClass(this.getOwnerComponent().getContentDensityClass());this.aCols=[];this.aColsDetails=[];this.columnData=[];this.columnDataDetail=[];this.oEditRecord={};this.iRecordCount=0;this.hasChangedUnits=false;this.hasChangedTerms=false;this.hasChangePricing=false;this.oPage=this.getView().byId("pageQuotation");this.tableId="tblQuotation";this.tableIdDetail="tblQuotationUnits";this.oMdlEditRecord=new e("model/Quotation.json");this.getView().setModel(this.oMdlEditRecord,"oMdlEditRecord");this.oMdlAllRecord=new e;this.oMdlAllRecordDetail=new e;this.oMdlAllUnits=new e;this.oTableDetail=this.getView().byId(this.tableIdDetail);this.oIconTab=this.getView().byId("tab1");this.oIconTab2=this.getView().byId("tab2");this.recordCode="";this.currentDate=new Date;this.oTableUnits=this.getView().byId("tblUnits");this.oTableSchedule=this.getView().byId("tblSchedule");this.oMdlStatGroup=new e("model/QuotationStatGroup.json");this.getView().setModel(this.oMdlStatGroup,"oMdlStatGroup");this.oMdlUnitTable=new e("model/QuotationUnitTable.json");this.getView().setModel(this.oMdlUnitTable,"oMdlUnitTable");this.iTotalSellingPrice=0;this.oMdlAllBP=new e;$.ajax({url:"/rexsjs/public/rexsjs/ExecQuery.xsjs?dbName=APP_RE&procName=SPAPP_RE_SELECTCOLS&tableName=M_CUSTOMER&selectColumns=CustomerCode,FirstName,MiddleName,LastName",type:"GET",xhrFields:{withCredentials:true},error:function(t,e,o){i.show(o)},success:function(t){},context:this}).done(function(t){if(t){this.oMdlAllBP.setJSON('{"allbp" : '+JSON.stringify(t)+"}");this.getView().setModel(this.oMdlAllBP,"oMdlAllBP")}});this.oMdlPricing=new e("model/QuotationPricing.json");this.getView().setModel(this.oMdlPricing,"oMdlPricing");this.oMdlDocStatus=new e;$.ajax({url:"/rexsjs/public/rexsjs/ExecQuery.xsjs?dbName=APP_RE&procName=SPAPP_RE_GETALLDATA&tableName=R_DOC_STATUS",type:"GET",xhrFields:{withCredentials:true},error:function(t,e,o){i.show(o)},success:function(t){},context:this}).done(function(t){if(t){this.oMdlDocStatus.setJSON('{"alldocstatus" : '+JSON.stringify(t)+"}");this.getView().setModel(this.oMdlDocStatus,"oMdlDocStatus")}});this.oMdlTerms=new e("model/QuotationTermsTable.json");this.getView().setModel(this.oMdlTerms,"oMdlTerms");this.oMdlFinSchemes=new e("model/QuotationFinSchemes.json");this.getView().setModel(this.oMdlFinSchemes,"oMdlFinSchemes");this.oMdlTaxes=new e;$.ajax({url:"/rexsjs/public/rexsjs/ExecQuery.xsjs?dbName=APP_RE&procName=SPAPP_RE_SELECTCOLS&tableName=M_TAX_MATRIX&selectColumns=TaxCode,TaxDesc,Rate",type:"GET",xhrFields:{withCredentials:true},error:function(t,e,o){i.show(o)},success:function(t){},context:this}).done(function(t){if(t){this.oMdlTaxes.setJSON('{"alltaxes" : '+JSON.stringify(t)+"}");this.getView().setModel(this.oMdlTaxes,"oMdlTaxes")}});this.prepareTable(true)},prepareTable:function(t){var e=r.getHANAData("QUOTATION","GET_TABLEVIEW","","");if(e.length!==0){this.aCols=Object.keys(e[0]);var i;this.iRecordCount=e.length;this.oIconTab.setCount(this.iRecordCount);if(t){for(i=0;i<this.aCols.length;i++){this.columnData.push({columnName:this.aCols[i]})}}this.oMdlAllRecord.setData({rows:e,columns:this.columnData});if(t){this.oTable=this.getView().byId(this.tableId);this.oTable.setModel(this.oMdlAllRecord);this.oTable.bindColumns("/columns",function(t,e){var i=e.getObject().columnName;return new sap.ui.table.Column({label:i,template:new sap.m.Text({text:"{"+i+"}"})})});this.oTable.bindRows("/rows");this.oTable.setSelectionMode("Single");this.oTable.setSelectionBehavior("Row");this.renameColumns()}}},renameColumns:function(){this.oTable.getColumns()[0].setVisible(false);this.oTable.getColumns()[1].setLabel("Quote Number");this.oTable.getColumns()[1].setFilterProperty("QuoteNum");this.oTable.getColumns()[2].setLabel("Customer Code");this.oTable.getColumns()[3].setFilterProperty("Name");this.oTable.getColumns()[4].setLabel("Quote Price");this.oTable.getColumns()[4].setFilterProperty("NetPrice");this.oTable.getColumns()[5].setLabel("Created Date")},onSelectStatGroup:function(t){var e=t.getSource().getSelectedItem().getProperty("key");var i=[];switch(e){case"1":i=r.getHANAData("QUOTATION","GET_TABLEVIEW","","");this.oMdlAllRecord.setData({rows:i,columns:this.columnData});break;case"2":i=r.getHANAData("QUOTATION","GET_TABLEVIEW_CREATEDTODAY","","");this.oMdlAllRecord.setData({rows:i,columns:this.columnData});break;case"3":console.log("GET_TABLEVIEW_NOCONTRACT");i=r.getHANAData("QUOTATION","GET_TABLEVIEW_NOCONTRACT","","");break;case"4":console.log("GET_TABLEVIEW_WITHCONTRACT");i=r.getHANAData("QUOTATION","GET_TABLEVIEW_WITHCONTRACT","","");break;case"5":console.log("GET_TABLEVIEW_SIMILARUNITS");i=r.getHANAData("QUOTATION","GET_TABLEVIEW_SIMILARUNITS","","");break;case"6":console.log("GET_TABLEVIEW_CREATEDMONTH");i=r.getHANAData("QUOTATION","GET_TABLEVIEW_CREATEDMONTH","","");break;default:break}},handleOpen:function(t){var e=t.getSource();if(!this._actionSheet){this._actionSheet=sap.ui.xmlfragment("com.apptech.realestate.view.fragments.QuotationActionFragment",this);this.getView().addDependent(this._actionSheet)}this._actionSheet.openBy(e)},actionSelected:function(t){var o=t.getSource();switch(t.getSource().getText()){case"Set as Reserved":if(this.bIsAdd==="A"){i.show("Save as Quotation first ")}i.show("Set as Reserved");break;case"View Draft Computation":this.oMdlAllAmortSched=new e;$.ajax({url:"/rexsjs/public/rexsjs/ExecQuery.xsjs?dbName=APP_RE&procName=SPAPP_RE_GENERATEAMORT&keyValue="+this.oMdlEditRecord.getData().EditRecord.QuoteNum,type:"GET",async:false,xhrFields:{withCredentials:true},error:function(t,e,i){},success:function(t){},context:this}).done(function(t){if(t.length<=0){}else{this.oMdlAllAmortSched.setJSON(JSON.stringify(t));this.getView().setModel(this.oMdlAllAmortSched,"oMdlAllAmortSched")}});this.oTableAmortSched=new sap.ui.table.Table({selectionMode:sap.ui.table.SelectionMode.Single});this.oTableAmortSched.addColumn(new sap.ui.table.Column({label:new sap.m.Label({text:"Description"}),template:new sap.m.Text({text:"{oMdlAllAmortSched>Description}"})}));this.oTableAmortSched.addColumn(new sap.ui.table.Column({label:new sap.m.Label({text:"Due Date"}),template:new sap.m.Text({text:"{path: 'oMdlAllAmortSched>StartDate'}"})}));this.oTableAmortSched.addColumn(new sap.ui.table.Column({label:new sap.m.Label({text:"Amount"}),template:new sap.m.Text({text:"{path: 'oMdlAllAmortSched>Amount', type: 'sap.ui.model.type.Float', formatOptions: {maxFractionDigits: 2, minFractionDigits: 2} }"})}));this.oTableAmortSched.addColumn(new sap.ui.table.Column({label:new sap.m.Label({text:"Interest"}),template:new sap.m.Text({text:"{path: 'oMdlAllAmortSched>Interest', type: 'sap.ui.model.type.Float', formatOptions: {maxFractionDigits: 2, minFractionDigits: 2} }"})}));this.oTableAmortSched.addColumn(new sap.ui.table.Column({label:new sap.m.Label({text:"Rate"}),template:new sap.m.Text({text:"{oMdlAllAmortSched>InterestRate}"})}));this.oTableAmortSched.addColumn(new sap.ui.table.Column({label:new sap.m.Label({text:"Principal"}),template:new sap.m.Text({text:"{path: 'oMdlAllAmortSched>Principal', type: 'sap.ui.model.type.Float', formatOptions: {maxFractionDigits: 2, minFractionDigits: 2} }"})}));this.oTableAmortSched.addColumn(new sap.ui.table.Column({label:new sap.m.Label({text:"Running Balance"}),template:new sap.m.Text({text:"{path: 'oMdlAllAmortSched>Running Balance', type: 'sap.ui.model.type.Float', formatOptions: {maxFractionDigits: 2, minFractionDigits: 2} }"})}));this.oMdlAllAmortSched.getData();var a={};a.T_AMORTSCHED_QUOTE=[];a.T_AMORTSCHED_QUOTE=JSON.parse(JSON.stringify(this.oMdlAllAmortSched.getData()));a.T_AMORTSCHED_QUOTE.forEach(function(t){r.renameKey(t,"Running Balance","DueBalance");r.renameKey(t,"Amount","DueAmt");r.renameKey(t,"StartDate","DueDate");r.renameKey(t,"QuoteNum","DocNum");r.deleteKey(t,"InterestRate");r.addKey(t,"Status","1");r.addKey(t,"O","I")});$.ajax({url:"/rexsjs/public/rexsjs/ExecQuery.xsjs?dbName=APP_RE&procName=SPAPP_RE_DELETE&whereCol1=DocNum&whereVal1="+this.oMdlEditRecord.getData().EditRecord.QuoteNum+"&whereCol2=&whereVal=",type:"GET",xhrFields:{withCredentials:true},error:function(t,e,o){i.show(o)},success:function(t){},context:this}).done(function(t){});var d=r.postData(a);if(d===0){}else{i.show("Error");jQuery.sap.log.error("Error on actionSelected() Quotation controller")}this.oTableAmortSched.setModel(this.oMdlAllAmortSched);this.oTableAmortSched.bindRows("oMdlAllAmortSched>/");if(!this.amortDialog){this.amortDialog=new s({title:"Amortization Schedule",contentWidth:"70rem",contentHeight:"50rem",draggable:true,content:this.oTableAmortSched,endButton:new c({text:"Close",press:function(){this.amortDialog.close()}.bind(this)})});this.getView().addDependent(this.amortDialog)}this.amortDialog.open();break}i.show("Selected action is '"+t.getSource().getText()+"'")},onAddUnit:function(){this.hasChangedUnits=true;$.ajax({url:"/rexsjs/public/rexsjs/ExecQuery.xsjs?dbName=APP_RE&procName=SPAPP_RE_FRAGMENTTABLE&fragmentTag=ChooseUnit",type:"GET",xhrFields:{withCredentials:true},error:function(t,e,o){i.show(o)},success:function(t){},context:this}).done(function(t){if(t){this.oMdlAllUnits.setJSON('{"allunitchoose" : '+JSON.stringify(t)+"}");this.getView().setModel(this.oMdlAllUnits,"oMdlAllUnits")}});if(!this._oDialog){this._oDialog=sap.ui.xmlfragment("com.apptech.realestate.view.fragments.UnitChooseDialogFragment",this)}this.getView().addDependent(this._oDialog);jQuery.sap.syncStyleClass("sapUiSizeCompact",this.getView(),this._oDialog);this._oDialog.open()},onRemoveUnit:function(t){this.hasChangedUnits=true;var e=this.oTableUnits.getBinding().getModel().getData().unitrows[this.oTableUnits.getBinding().aIndices[this.oTableUnits.getSelectedIndex()]];this.iTotalSellingPrice=Math.abs(this.iTotalSellingPrice-e.Price);this.oMdlPricing.getData().EditRecord.PriceTotal=this.iTotalSellingPrice;this.oMdlPricing.getData().EditRecord.GrossPrice=this.iTotalSellingPrice;var i=this.oMdlUnitTable.getData().unitrows.filter(function(t,i,o){return t.UnitCode!==e.UnitCode});if(i.length===0){this.oMdlPricing.getData().EditRecord.PriceTotal=0;this.oMdlPricing.getData().EditRecord.GrossPrice=0}this.oMdlUnitTable.getData().unitrows=i;this.oMdlUnitTable.refresh();this.computePricingTab(false,this.iTotalSellingPrice)},handleClose:function(t){var e=t.getSource().getBinding("items");var i=t.getParameter("selectedContexts");if(i!==undefined){var o=parseInt(i[0].sPath.match(/\d+/),10);var a=i[0].oModel.getData().allunitchoose[o];this.oMdlUnitTable.getData().unitrows.push(a);this.iTotalSellingPrice+=a.Price;this.oMdlPricing.getData().EditRecord.PriceTotal=this.iTotalSellingPrice;this.oMdlPricing.getData().EditRecord.GrossPrice=this.iTotalSellingPrice;var r=this.oMdlUnitTable.getData().unitrows.filter(function(t){return t.Price>0});this.oMdlUnitTable.getData().unitrows=r;this.oMdlUnitTable.refresh();this.oMdlPricing.refresh();e.filter([]);this.computePricingTab(false,this.iTotalSellingPrice)}},onChangeTaxCode:function(t){var e=t.getParameter("selectedItem").getProperty("key");var i=this.oMdlTaxes.getData().alltaxes.filter(function(t){return t.TaxCode==e});this.oMdlPricing.getData().EditRecord._TaxRate=i[0].Rate;this.oMdlPricing.getData().EditRecord.TaxAmount=this.oMdlPricing.getData().EditRecord.NetPrice*(this.oMdlPricing.getData().EditRecord._TaxRate/100);this.oMdlPricing.getData().EditRecord.GrossPrice=this.oMdlPricing.getData().EditRecord.NetPrice-this.oMdlPricing.getData().EditRecord.TaxAmount;this.oMdlPricing.getData().EditRecord.DiscAmountAVat=this.oMdlPricing.getData().EditRecord.GrossPrice*(this.oMdlPricing.getData().EditRecord.DiscPercentAVat/100);var o=this.oMdlPricing.getData().EditRecord.GrossPrice-this.oMdlPricing.getData().EditRecord.DiscAmountAVat;this.oMdlPricing.getData().EditRecord.DPAmount=o*(this.oMdlPricing.getData().EditRecord.DPPercent/100);this.oMdlPricing.getData().EditRecord.DPNetAmount=this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee<0?0:this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee;this.oMdlPricing.getData().EditRecord.MFAmount=(o-this.oMdlPricing.getData().EditRecord.DPNetAmount)*(this.oMdlPricing.getData().EditRecord.MFPercent/100);this.oMdlPricing.getData().EditRecord.RBAmount=o-this.oMdlPricing.getData().EditRecord.DPNetAmount-this.oMdlPricing.getData().EditRecord.MFAmount;this.oMdlPricing.refresh()},onChangeDiscPercentBVat:function(t){this.oMdlPricing.getData().EditRecord.DiscAmountBVat=this.oMdlPricing.getData().EditRecord.PriceTotal*(parseFloat(t.getParameter("newValue").replace(/,/g,""))/100);this.oMdlPricing.getData().EditRecord.NetPrice=this.oMdlPricing.getData().EditRecord.PriceTotal-this.oMdlPricing.getData().EditRecord.DiscAmountBVat;this.oMdlPricing.getData().EditRecord.TaxAmount=this.oMdlPricing.getData().EditRecord.NetPrice*(this.oMdlPricing.getData().EditRecord._TaxRate/100);this.oMdlPricing.getData().EditRecord.GrossPrice=this.oMdlPricing.getData().EditRecord.NetPrice-this.oMdlPricing.getData().EditRecord.TaxAmount;this.oMdlPricing.getData().EditRecord.DiscAmountAVat=this.oMdlPricing.getData().EditRecord.GrossPrice*(this.oMdlPricing.getData().EditRecord.DiscPercentAVat/100);var e=this.oMdlPricing.getData().EditRecord.GrossPrice-this.oMdlPricing.getData().EditRecord.DiscAmountAVat;this.oMdlPricing.getData().EditRecord.DPAmount=e*(this.oMdlPricing.getData().EditRecord.DPPercent/100);this.oMdlPricing.getData().EditRecord.DPNetAmount=this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee<0?0:this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee;this.oMdlPricing.getData().EditRecord.MFAmount=e*(this.oMdlPricing.getData().EditRecord.MFPercent/100);this.oMdlPricing.getData().EditRecord.RBAmount=e-this.oMdlPricing.getData().EditRecord.DPNetAmount},onChangeDiscAmountBVat:function(t){this.oMdlPricing.getData().EditRecord.DiscPercentBVat=parseFloat(t.getParameter("newValue").replace(/,/g,""))/this.oMdlPricing.getData().EditRecord.PriceTotal*100;this.oMdlPricing.getData().EditRecord.NetPrice=this.oMdlPricing.getData().EditRecord.PriceTotal-this.oMdlPricing.getData().EditRecord.DiscAmountBVat;this.oMdlPricing.getData().EditRecord.TaxAmount=this.oMdlPricing.getData().EditRecord.NetPrice*(this.oMdlPricing.getData().EditRecord._TaxRate/100);this.oMdlPricing.getData().EditRecord.GrossPrice=this.oMdlPricing.getData().EditRecord.NetPrice-this.oMdlPricing.getData().EditRecord.TaxAmount;this.oMdlPricing.getData().EditRecord.DiscAmountAVat=this.oMdlPricing.getData().EditRecord.GrossPrice*(this.oMdlPricing.getData().EditRecord.DiscPercentAVat/100);var e=this.oMdlPricing.getData().EditRecord.GrossPrice-this.oMdlPricing.getData().EditRecord.DiscAmountAVat;this.oMdlPricing.getData().EditRecord.DPAmount=e*(this.oMdlPricing.getData().EditRecord.DPPercent/100);this.oMdlPricing.getData().EditRecord.DPNetAmount=this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee<0?0:this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee;this.oMdlPricing.getData().EditRecord.MFAmount=e*(this.oMdlPricing.getData().EditRecord.MFPercent/100);this.oMdlPricing.getData().EditRecord.RBAmount=e-this.oMdlPricing.getData().EditRecord.DPNetAmount},onChangeDiscPercentAVat:function(t){this.oMdlPricing.getData().EditRecord.DiscAmountAVat=this.oMdlPricing.getData().EditRecord.GrossPrice*(parseFloat(t.getParameter("newValue").replace(/,/g,""))/100);var e=this.oMdlPricing.getData().EditRecord.GrossPrice-this.oMdlPricing.getData().EditRecord.DiscAmountAVat;this.oMdlPricing.getData().EditRecord.DPAmount=e*(this.oMdlPricing.getData().EditRecord.DPPercent/100);this.oMdlPricing.getData().EditRecord.DPNetAmount=this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee<0?0:this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee;this.oMdlPricing.getData().EditRecord.MFAmount=e*(this.oMdlPricing.getData().EditRecord.MFPercent/100);this.oMdlPricing.getData().EditRecord.RBAmount=e-this.oMdlPricing.getData().EditRecord.DPNetAmount},onChangeDiscAmountAVat:function(t){this.oMdlPricing.getData().EditRecord.DiscPercentAVat=parseFloat(t.getParameter("newValue").replace(/,/g,""))/this.oMdlPricing.getData().EditRecord.GrossPrice*100;var e=this.oMdlPricing.getData().EditRecord.GrossPrice-this.oMdlPricing.getData().EditRecord.DiscAmountAVat;this.oMdlPricing.getData().EditRecord.DPAmount=e*(this.oMdlPricing.getData().EditRecord.DPPercent/100);this.oMdlPricing.getData().EditRecord.DPNetAmount=this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee<0?0:this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee;this.oMdlPricing.getData().EditRecord.MFAmount=e*(this.oMdlPricing.getData().EditRecord.MFPercent/100);this.oMdlPricing.getData().EditRecord.RBAmount=e-this.oMdlPricing.getData().EditRecord.DPNetAmount},onChangeDPPercent:function(t){var e=this.oMdlPricing.getData().EditRecord.GrossPrice-this.oMdlPricing.getData().EditRecord.DiscAmountAVat;this.oMdlPricing.getData().EditRecord.DPAmount=e*(parseFloat(t.getParameter("newValue").replace(/,/g,""))/100);this.oMdlPricing.getData().EditRecord.DPNetAmount=this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee<0?0:this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee;this.oMdlPricing.getData().EditRecord.MFAmount=e*(this.oMdlPricing.getData().EditRecord.MFPercent/100);this.oMdlPricing.getData().EditRecord.RBAmount=e-this.oMdlPricing.getData().EditRecord.DPNetAmount},onChangeDPAmount:function(t){var e=this.oMdlPricing.getData().EditRecord.GrossPrice-this.oMdlPricing.getData().EditRecord.DiscAmountAVat;this.oMdlPricing.getData().EditRecord.DPPercent=parseFloat(t.getParameter("newValue").replace(/,/g,""))/e*100;this.oMdlPricing.getData().EditRecord.DPNetAmount=this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee<0?0:this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee;this.oMdlPricing.getData().EditRecord.MFAmount=e*(this.oMdlPricing.getData().EditRecord.MFPercent/100);this.oMdlPricing.getData().EditRecord.RBAmount=e-this.oMdlPricing.getData().EditRecord.DPNetAmount},onChangeRsvFee:function(t){var e=this.oMdlPricing.getData().EditRecord.GrossPrice-this.oMdlPricing.getData().EditRecord.DiscAmountAVat;this.oMdlPricing.getData().EditRecord.DPNetAmount=this.oMdlPricing.getData().EditRecord.DPAmount-parseFloat(t.getParameter("newValue").replace(/,/g,""))<0?0:this.oMdlPricing.getData().EditRecord.DPAmount-parseFloat(t.getParameter("newValue").replace(/,/g,""));this.oMdlPricing.getData().EditRecord.MFAmount=e*(this.oMdlPricing.getData().EditRecord.MFPercent/100);this.oMdlPricing.getData().EditRecord.RBAmount=e-this.oMdlPricing.getData().EditRecord.DPNetAmount;var i=t.getParameter("newValue").replace(/,/g,"");if(i>0){var o=this.oMdlTerms.getData().EditRecord.filter(function(t,e,i){return t.LineNum>1});this.oMdlTerms.getData().EditRecord=o;var a={};a.LineNum=1;a.Amount=i;a.TranType=[{Code:"1",Desc:"Reservation"},{Code:"2",Desc:"Downpayment"},{Code:"3",Desc:"Remaining Balance"},{Code:"4",Desc:"Misc Fee"}];a.SelectedTranType="1";a.Percent=100;a.Interest=0;a.Terms=1;a.StartDate=this.currentDate.getMonth()+1+"/"+this.currentDate.getDate()+"/"+this.currentDate.getFullYear();a.FinanceScheme="5";this.oMdlTerms.getData().EditRecord.push(a);this.oMdlTerms.refresh()}},onChangeMFPercent:function(t){var e=this.oMdlPricing.getData().EditRecord.GrossPrice-this.oMdlPricing.getData().EditRecord.DiscAmountAVat;this.oMdlPricing.getData().EditRecord.MFAmount=e*(parseFloat(t.getParameter("newValue").replace(/,/g,""))/100)},onChangeMFAmount:function(t){var e=this.oMdlPricing.getData().EditRecord.GrossPrice-this.oMdlPricing.getData().EditRecord.DiscAmountAVat;this.oMdlPricing.getData().EditRecord.MFPercent=parseFloat(t.getParameter("newValue").replace(/,/g,""))/e*100},computePricingTab:function(t,e){if(t){this.oMdlPricing.getData().EditRecord.GrossPrice=0;this.oMdlPricing.getData().EditRecord.PriceTotal=0;this.oMdlPricing.getData().EditRecord.DiscPercentBVat=0;this.oMdlPricing.getData().EditRecord.DiscAmountBVat=0;this.oMdlPricing.getData().EditRecord.TaxMatrixCode="1";this.oMdlPricing.getData().EditRecord.TaxAmount=0;this.oMdlPricing.getData().EditRecord.PenaltyPercent=0;this.oMdlPricing.getData().EditRecord.NetPrice=0;this.oMdlPricing.getData().EditRecord.DiscPercentAVat=0;this.oMdlPricing.getData().EditRecord.DiscAmountAVat=0;this.oMdlPricing.getData().EditRecord.GrossPrice=0;this.oMdlPricing.getData().EditRecord.EWTRate=0;this.oMdlPricing.getData().EditRecord.DPPercent=0;this.oMdlPricing.getData().EditRecord.DPAmount=0;this.oMdlPricing.getData().EditRecord.RBPercent=0;this.oMdlPricing.getData().EditRecord.RBAmount=0;this.oMdlPricing.getData().EditRecord.MFPercent=0;this.oMdlPricing.getData().EditRecord.MFAmount=0;this.oMdlPricing.refresh()}else{if(e!==0){this.oMdlPricing.getData().EditRecord.DiscAmountBVat=this.oMdlPricing.getData().EditRecord.PriceTotal*(this.oMdlPricing.getData().EditRecord.DiscPercentBVat/100);this.oMdlPricing.getData().EditRecord.NetPrice=this.oMdlPricing.getData().EditRecord.PriceTotal-this.oMdlPricing.getData().EditRecord.DiscAmountBVat;this.oMdlPricing.getData().EditRecord.TaxAmount=this.oMdlPricing.getData().EditRecord.NetPrice*(this.oMdlPricing.getData().EditRecord._TaxRate/100);this.oMdlPricing.getData().EditRecord.GrossPrice=this.oMdlPricing.getData().EditRecord.NetPrice-this.oMdlPricing.getData().EditRecord.TaxAmount;this.oMdlPricing.getData().EditRecord.DiscAmountAVat=this.oMdlPricing.getData().EditRecord.GrossPrice*(this.oMdlPricing.getData().EditRecord.DiscPercentAVat/100);var i=this.oMdlPricing.getData().EditRecord.GrossPrice-this.oMdlPricing.getData().EditRecord.DiscAmountAVat;this.oMdlPricing.getData().EditRecord.DPAmount=i*(this.oMdlPricing.getData().EditRecord.DPPercent/100);this.oMdlPricing.getData().EditRecord.DPNetAmount=this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee<0?0:this.oMdlPricing.getData().EditRecord.DPAmount-this.oMdlPricing.getData().EditRecord.RsvFee;this.oMdlPricing.getData().EditRecord.MFAmount=i*(this.oMdlPricing.getData().EditRecord.MFPercent/100);this.oMdlPricing.getData().EditRecord.RBAmount=i-this.oMdlPricing.getData().EditRecord.DPNetAmount}}this.oMdlPricing.refresh()},onClearAdd:function(){try{this.oMdlEditRecord.getData().EditRecord.Code="";this.oMdlEditRecord.getData().EditRecord.QuoteNum="";this.oMdlEditRecord.getData().EditRecord.DocStatus="1";this.oMdlEditRecord.getData().EditRecord.CustomerCode="";this.oMdlEditRecord.getData().EditRecord.CustomerName="";this.oMdlEditRecord.getData().EditRecord.Remarks="";this.oMdlEditRecord.refresh();this.computePricingTab(true,0);this.oMdlUnitTable.getData().unitrows.length=0;this.oMdlTerms.getData().EditRecord.length=0;this.oMdlTerms.getData().NetDP=0;this.oMdlTerms.getData().NetRB=0;this.oMdlTerms.getData().NetMF=0;this.oMdlUnitTable.refresh();this.oMdlTerms.refresh();this.oMdlPricing.refresh();this.getView().byId("idIconTabBarInlineMode").getItems()[1].setText("RECORD [ADD]");var t=this.getView().byId("idIconTabBarInlineMode");t.setSelectedKey("tab2");this.bIsAdd="A"}catch(t){}},onSelectIconTabBarAddEdit:function(t){this.oMdlTerms.getData().NetDP=this.oMdlPricing.getData().EditRecord.DPNetAmount;this.oMdlTerms.getData().NetRB=this.oMdlPricing.getData().EditRecord.RBAmount;this.oMdlTerms.getData().NetMF=this.oMdlPricing.getData().EditRecord.MFAmount;this.oMdlTerms.refresh()},onAddSched:function(t){this.hasChangedTerms=true;var e={};e.LineNum=1;e.Amount=0;e.TranType=[{Code:"1",Desc:"Reservation"},{Code:"2",Desc:"Downpayment"},{Code:"3",Desc:"Remaining Balance"},{Code:"4",Desc:"Misc Fee"}];e.SelectedTranType="1";e.Percent=0;e.Interest=0;e.Terms=1;e.StartDate=this.currentDate.getMonth()+1+"/"+this.currentDate.getDate()+"/"+this.currentDate.getFullYear();e.FinanceScheme="1";this.oMdlTerms.getData().EditRecord.push(e);this.oMdlTerms.refresh()},onRemoveSched:function(t){this.oMdlTerms.getData().EditRecord.splice(this.oTableSchedule.getSelectedIndex(),1);this.oMdlTerms.refresh()},onSelectionChangeTranType:function(t){},onChangeTermPercent:function(t){if(t.getSource().getParent().getCells()[0].getSelectedKey()==="1"){var e=new s({title:"Error",type:"Message",state:"Error",content:new l({text:"You cannot breakdown further the Reservation Term."}),beginButton:new c({type:n.Emphasized,text:"OK",press:function(){e.close()}}),afterClose:function(){e.destroy()}})}else{var i=t.getSource().getParent();var o=i.getIndex();switch(t.getSource().getParent().getCells()[0].getSelectedKey()){case"2":this.oMdlTerms.getData().EditRecord[o].Amount=this.oMdlTerms.getData().NetDP*(this.oMdlTerms.getData().EditRecord[o].Percent/100);break;case"3":this.oMdlTerms.getData().EditRecord[o].Amount=this.oMdlTerms.getData().NetRB*(this.oMdlTerms.getData().EditRecord[o].Percent/100);break;case"4":this.oMdlTerms.getData().EditRecord[o].Amount=this.oMdlTerms.getData().NetMF*(this.oMdlTerms.getData().EditRecord[o].Percent/100);break}}},handleValueHelpBP:function(){if(!this._oValueHelpDialog){d.load({name:"com.apptech.realestate.view.fragments.BPDialogFragment",controller:this}).then(function(t){this._oValueHelpDialog=t;this.getView().addDependent(this._oValueHelpDialog);this._configValueHelpDialog();this._oValueHelpDialog.open()}.bind(this))}else{this._configValueHelpDialog();this._oValueHelpDialog.open()}},_configValueHelpDialog:function(){var t=this.byId("bpInput").getValue(),e=this.getView().getModel("oMdlAllBP"),i=e.getProperty("/allbp");i.forEach(function(e){e.selected=e.Name===t})},handleValueHelpCloseBP:function(t){var e=t.getParameter("selectedContexts");var i={};if(e&&e.length){i=e.map(function(t){var e={};e.CustomerCode=t.getObject().CustomerCode;e.CustomerName=t.getObject().FirstName+" "+t.getObject().MiddleName+" "+t.getObject().LastName;return e})}t.getSource().getBinding("items").filter([]);this.oMdlEditRecord.getData().EditRecord.CustomerCode=i[0].CustomerCode;this.oMdlEditRecord.getData().EditRecord.CustomerName=i[0].CustomerName;this.oMdlEditRecord.refresh()},onAdd:function(t){this.onClearAdd()},onSave:function(t){this.oPage.setBusy(true);this.onSaveProcess();this.oPage.setBusy(false)},onSaveProcess:function(){var t={};var e="";t.T_RE_QUOTE_H=[];t.T_RE_QUOTE_D=[];t.T_RE_QUOTE_PRICE_D=[];t.T_TERMS_QUOTE_DP=[];t.T_TERMS_QUOTE_RB=[];t.T_TERMS_QUOTE_MF=[];var o=[];var a=[];var d=[];var s=[];var n={};var c={};var l=0;if(this.bIsAdd==="E"){e=this.oMdlEditRecord.getData().EditRecord.QuoteNum;n.O="U";n.Code=this.oMdlEditRecord.getData().EditRecord.Code;n.QuoteNum=this.oMdlEditRecord.getData().EditRecord.QuoteNum;n.DocStatus="1";n.CustomerCode=this.oMdlEditRecord.getData().EditRecord.CustomerCode;o=r.getAllDataByColAJAX("","",this.oMdlEditRecord.getData().EditRecord.QuoteNum,"QuoteGetExistingUnits");for(l=0;l<o.length;l++){o[l].O="U";o[l].IsActive="N"}a=r.getAllDataByColAJAX("","",this.oMdlEditRecord.getData().EditRecord.QuoteNum,"QuoteGetExistingTermsDP");for(l=0;l<a.length;l++){a[l].O="U";a[l].IsActive="N"}d=r.getAllDataByColAJAX("","",this.oMdlEditRecord.getData().EditRecord.QuoteNum,"QuoteGetExistingTermsRB");for(l=0;l<d.length;l++){d[l].O="U";d[l].IsActive="N"}s=r.getAllDataByColAJAX("","",this.oMdlEditRecord.getData().EditRecord.QuoteNum,"QuoteGetExistingTermsMF");for(l=0;l<s.length;l++){s[l].O="U";s[l].IsActive="N"}c.O="U"}else if(this.bIsAdd==="A"){e=r.generateNumber("Quote")[0].Code;n.O="I";n.Code=r.generateUDTCode();n.QuoteNum=e;n.DocStatus="1";n.CustomerCode=this.oMdlEditRecord.getData().EditRecord.CustomerCode;c.O="I"}else{jQuery.sap.log.error("Please specify actions to perform");return}for(l=0;l<this.oMdlUnitTable.getData().unitrows.length;l++){var h={};h.O="I";h.Code=r.generateUDTCode();h.LineNum=l+1;h.QuoteNum=e;h.UnitCode=this.oMdlUnitTable.getData().unitrows[l].UnitCode;h.Price=this.oMdlUnitTable.getData().unitrows[l].Price;t.T_RE_QUOTE_D.push(h)}Array.prototype.push.apply(t.T_RE_QUOTE_D,o);t.T_RE_QUOTE_H.push(n);c.Code=c.O==="I"?r.generateUDTCode():this.oMdlPricing.getData().EditRecord.Code;c.QuoteNum=e;c.PriceTotal=this.oMdlPricing.getData().EditRecord.PriceTotal;c.PenaltyPercent=this.oMdlPricing.getData().EditRecord.PenaltyPercent;c.DiscPercentBVat=this.oMdlPricing.getData().EditRecord.DiscPercentBVat;c.DiscAmountBVat=this.oMdlPricing.getData().EditRecord.DiscAmountBVat;c.NetPrice=this.oMdlPricing.getData().EditRecord.NetPrice;c.TaxMatrixCode=this.oMdlPricing.getData().EditRecord.TaxMatrixCode;c.TaxAmount=this.oMdlPricing.getData().EditRecord.TaxAmount;c.GrossPrice=this.oMdlPricing.getData().EditRecord.GrossPrice;c.DiscPercentAVat=this.oMdlPricing.getData().EditRecord.DiscPercentAVat;c.DiscAmountAVat=this.oMdlPricing.getData().EditRecord.DiscAmountAVat;c.EWTRate=this.oMdlPricing.getData().EditRecord.EWTRate;c.RsvFee=this.oMdlPricing.getData().EditRecord.RsvFee;c.DPPercent=this.oMdlPricing.getData().EditRecord.DPPercent;c.DPAmount=this.oMdlPricing.getData().EditRecord.DPAmount;c.DPNetAmount=this.oMdlPricing.getData().EditRecord.DPNetAmount;c.RBpercent=this.oMdlPricing.getData().EditRecord.RBpercent;c.RBAmount=this.oMdlPricing.getData().EditRecord.RBAmount;c.MFPercent=this.oMdlPricing.getData().EditRecord.MFPercent;c.MFAmount=this.oMdlPricing.getData().EditRecord.MFAmount;t.T_RE_QUOTE_PRICE_D.push(c);var D=this.oMdlTerms.getData().EditRecord.filter(function(t,e,i){return t.SelectedTranType==="2"||t.SelectedTranType==="1"});var u;for(u=0;u<D.length;u++){var P=u+1;var m={};m.O="I";m.Code=r.generateUDTCode();m.QuoteNum=e;m.LineNum=P;m.Amount=D[u].Amount;m.Percent=D[u].Percent;m.Interest=D[u].Interest;m.TranType=D[u].SelectedTranType;m.Terms=D[u].Terms;m.StartDate=D[u].StartDate;m.FinanceScheme=D[u].FinanceScheme;t.T_TERMS_QUOTE_DP.push(m)}Array.prototype.push.apply(t.T_TERMS_QUOTE_DP,a);var M=this.oMdlTerms.getData().EditRecord.filter(function(t,e,i){return t.SelectedTranType==="3"});var E;for(E=0;E<M.length;E++){var R=E+1;var T={};T.O="I";T.Code=r.generateUDTCode();T.QuoteNum=e;T.LineNum=R;T.Amount=M[E].Amount;T.Percent=M[E].Percent;T.Interest=M[E].Interest;T.Terms=M[E].Terms;T.StartDate=M[E].StartDate;T.FinanceScheme=M[E].FinanceScheme;t.T_TERMS_QUOTE_RB.push(T)}Array.prototype.push.apply(t.T_TERMS_QUOTE_RB,d);var A=this.oMdlTerms.getData().EditRecord.filter(function(t,e,i){return t.SelectedTranType==="4"});var p;for(p=0;p<A.length;p++){var b=p+1;var C={};C.O="I";C.Code=r.generateUDTCode();C.QuoteNum=e;C.LineNum=b;C.Amount=A[p].Amount;C.Percent=A[p].Percent;C.Interest=A[p].Interest;C.Terms=A[p].Terms;C.StartDate=A[p].StartDate;C.FinanceScheme=A[p].FinanceScheme;t.T_TERMS_QUOTE_MF.push(C)}Array.prototype.push.apply(t.T_TERMS_QUOTE_MF,s);this.oPage.setBusy(false);var f=this;g.show("Do you want to save this record?",{styleClass:"sapUiSizeCompact",actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(o){if(o===sap.m.MessageBox.Action.YES){var a=r.postData(t);if(a===0){i.show("Saved Successfully "+e);f.prepareTable(false)}else{i.show("Error");jQuery.sap.log.error("Error on onSave() Quotation controller")}}}})},onEdit:function(t){var e=this.oTable.getSelectedIndex();var i="T_RE_QUOTE_H";var o="";if(e!=-1){var a=this.oTable.getBinding().getModel().getData().rows[this.oTable.getBinding().aIndices[e]];o=a.Code;var d=r.getAllDataByKeyAJAX(i,o,"QuoteGetHeader");d=JSON.stringify(d).replace("[","").replace("]","");this.oMdlEditRecord.setJSON('{"EditRecord" : '+d+"}");this.getView().setModel(this.oMdlEditRecord,"oMdlEditRecord");this.getView().byId("idIconTabBarInlineMode").getItems()[1].setText("Record Code : "+this.oMdlEditRecord.getData().EditRecord.QuoteNum+" [EDIT]");var s=r.getAllDataByColAJAX("","",this.oMdlEditRecord.getData().EditRecord.QuoteNum,"QuoteGetUnit");var n=s.filter(function(t){return t.IsActive!=="N"});this.oMdlUnitTable.setJSON('{"unitrows" : '+JSON.stringify(n)+"}");this.oMdlUnitTable.refresh();var c=0;this.iTotalSellingPrice=this.oMdlUnitTable.getData().unitrows.reduce(function(t,e){return t+e.Price},c);var l=r.getAllDataByColAJAX("","",this.oMdlEditRecord.getData().EditRecord.QuoteNum,"QuoteGetPrice");var g='{"EditRecord" : '+JSON.stringify(l).replace("[","").replace("]","")+"}";this.oMdlPricing.setJSON(g);this.oMdlPricing.refresh();var h=r.getAllDataByColAJAX("","",this.oMdlEditRecord.getData().EditRecord.QuoteNum,"QuoteGetTerms");for(var D=0;D<h.length;D++){h[D].TranType=[{Code:"1",Desc:"Reservation"},{Code:"2",Desc:"Downpayment"},{Code:"3",Desc:"Remaining Balance"},{Code:"4",Desc:"Misc Fee"}]}var u='{"EditRecord" : '+JSON.stringify(h)+"}";this.oMdlTerms.setJSON(u);this.oMdlTerms.refresh()}this.recordCode=o;var P=this.getView().byId("idIconTabBarInlineMode");P.setSelectedKey("tab2");this.bIsAdd="E"},validateBeforeOnSave:function(t){},onSelectionChange:function(t){var e=t.getSource().getSelectedIndex();if(e!==-1){var i=this.oTable.getBinding().getModel().getData().rows[this.oTable.getBinding().aIndices[e]];this.prepareTableDetail(i.QuoteNum)}},prepareTableDetail:function(t){var e=r.getHANAData("QUOTATION","GET_TABLEVIEWDETAILS",t,"");if(e.length!==0){this.aColsDetails=Object.keys(e[0]);var i;if(this.columnDataDetail.length<=0){for(i=0;i<this.aColsDetails.length;i++){this.columnDataDetail.push({columnName:this.aColsDetails[i]})}}this.oMdlAllRecordDetail.setData({rows:e,columns:this.columnDataDetail});var o=true;if(o){this.oTableDetail=this.getView().byId(this.tableIdDetail);this.oTableDetail.setModel(this.oMdlAllRecordDetail);this.oTableDetail.bindColumns("/columns",function(t,e){var i=e.getObject().columnName;return new sap.ui.table.Column({label:i,template:new sap.m.Text({text:"{"+i+"}"})})});this.oTableDetail.bindRows("/rows");this.oTableDetail.setSelectionMode("Single");this.oTableDetail.setSelectionBehavior("Row");this.renameColumnsDetail()}}},renameColumnsDetail:function(){this.oTableDetail.getColumns()[0].setVisible(false)}})});