sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","com/apptech/realestate/controller/AppUI5"],function(t,e,o,i,a,s){"use strict";return t.extend("com.apptech.realestate.controller.Reservation",{onRoutePatternMatched:function(t){this.getView().addStyleClass(this.getOwnerComponent().getContentDensityClass());this.prepareTable(false)},onInit:function(){var t=this.getOwnerComponent().getRouter().getRoute("Reservation");t.attachPatternMatched(this.onRoutePatternMatched,this);this.bIsAdd=true;this.tableId="tblReservation";this.tableIdDetail="tblReservationUnits";this.getView().addStyleClass(this.getOwnerComponent().getContentDensityClass());this.aCols=[];this.aColsDetails=[];this.columnData=[];this.columnDataDetail=[];this.oEditRecord={};this.iRecordCount=0;this.oIconTab=this.getView().byId("tab1");this.oIconTab2=this.getView().byId("tab2");this.recordCode="";this.oMdlAllRecord=new e;this.oMdlAllRecordDetail=new e;this.oTableDetail=this.getView().byId(this.tableIdDetail);this.prepareTable(true)},onSelectionChange:function(t){var e=t.getSource().getSelectedIndex();if(e!==-1){var o=this.oTable.getBinding().getModel().getData().rows[this.oTable.getBinding().aIndices[e]];this.prepareTableDetail(o.DocNum)}},handleOpen:function(t){var e=t.getSource();if(!this._actionSheet){this._actionSheet=sap.ui.xmlfragment("com.apptech.realestate.view.fragments.ReservationActionFragment",this);this.getView().addDependent(this._actionSheet)}this._actionSheet.openBy(e)},actionSelected:function(t){o.show("Selected action is '"+t.getSource().getText()+"'")},prepareTableDetail:function(t){$.ajax({url:"/rexsjs/public/rexsjs/ExecQuery.xsjs?dbName=APP_RE&procName=SPAPP_RE_VIEWTABLE&tableName=T_RE_D&parameterCode="+t,type:"GET",xhrFields:{withCredentials:true},error:function(t,e,i){o.show(i)},success:function(t){},context:this}).done(function(t){if(t.length!==0){this.aColsDetails=Object.keys(t[0]);var e;if(this.columnDataDetail.length<=0){for(e=0;e<this.aColsDetails.length;e++){this.columnDataDetail.push({columnName:this.aColsDetails[e]})}}this.oMdlAllRecordDetail.setData({rows:t,columns:this.columnDataDetail});var o=true;if(o){this.oTableDetail=this.getView().byId(this.tableIdDetail);this.oTableDetail.setModel(this.oMdlAllRecordDetail);this.oTableDetail.bindColumns("/columns",function(t,e){var o=e.getObject().columnName;return new sap.ui.table.Column({label:o,template:new sap.m.Text({text:"{"+o+"}"})})});this.oTableDetail.bindRows("/rows");this.oTableDetail.setSelectionMode("Single");this.oTableDetail.setSelectionBehavior("Row");this.renameColumnsDetail()}}})},prepareTable:function(t){$.ajax({url:"/rexsjs/public/rexsjs/ExecQuery.xsjs?dbName=APP_RE&procName=SPAPP_RE_VIEWTABLE&tableName=T_RE_H&parameterCode=0",type:"GET",xhrFields:{withCredentials:true},error:function(t,e,i){o.show(i)},success:function(t){},context:this}).done(function(e){if(e){this.aCols=Object.keys(e[0]);var o;this.iRecordCount=e.length;this.oIconTab.setCount(this.iRecordCount);if(t){for(o=0;o<this.aCols.length;o++){this.columnData.push({columnName:this.aCols[o]})}}this.oMdlAllRecord.setData({rows:e,columns:this.columnData});if(t){this.oTable=this.getView().byId(this.tableId);this.oTable.setModel(this.oMdlAllRecord);this.oTable.bindColumns("/columns",function(t,e){var o=e.getObject().columnName;var i=function(t){var e=new Date(t);t=e.toLocaleDateString("en-US");return t};var a=function(t){if(null!==t){t=t.toLocaleString("en");return t}};switch(o){case"RsvDate":return new sap.ui.table.Column({label:o,template:new sap.m.Text({text:{path:o,formatter:i}})});case"CreatedDate":return new sap.ui.table.Column({label:o,template:new sap.m.Text({text:{path:o,formatter:i}})});case"RunningBalance":return new sap.ui.table.Column({label:o,template:new sap.m.Text({text:{path:o,formatter:a}})});default:return new sap.ui.table.Column({label:o,template:new sap.m.Text({text:"{"+o+"}"})})}});this.oTable.bindRows("/rows");this.oTable.setSelectionMode("Single");this.oTable.setSelectionBehavior("Row");this.renameColumns()}}})},renameColumns:function(){this.oTable.getColumns()[0].setVisible(false);this.oTable.getColumns()[1].setLabel("RE Number");this.oTable.getColumns()[2].setLabel("RE Status");this.oTable.getColumns()[3].setLabel("Customer Code");this.oTable.getColumns()[4].setLabel("Financing Scheme");this.oTable.getColumns()[5].setLabel("Reservation Date");this.oTable.getColumns()[6].setLabel("Created Date");this.oTable.getColumns()[7].setLabel("Running Balance");this.oTable.getColumns()[1].setFilterProperty("DocNum");this.oTable.getColumns()[2].setFilterProperty("DocStatus");this.oTable.getColumns()[3].setFilterProperty("CustomerCode");this.oTable.getColumns()[4].setFilterProperty("FinanceScheme");this.oTable.getColumns()[7].setFilterProperty("RunningBalance")},renameColumnsDetail:function(){this.oTableDetail.getColumns()[0].setVisible(false)},onEdit:function(t){var e=this.oTable.getSelectedIndex();var i="M_UNIT";var a="";if(e!==-1){var s=this.oTable.getBinding().getModel().getData().rows[this.oTable.getBinding().aIndices[e]];a=s.Code;$.ajax({url:"/rexsjs/public/rexsjs/ExecQuery.xsjs?dbName=APP_RE&procName=SPAPP_RE_GETALLDATA_BYKEY&tableName="+i+"&keyCode="+a,type:"GET",xhrFields:{withCredentials:true},error:function(t,e,i){o.show(i)},success:function(t){},context:this}).done(function(t){if(t.length<=0){return}var e=JSON.stringify(t).replace("[","").replace("]","");this.oMdlEditRecord.setJSON('{"EditRecord" : '+e+"}");this.getView().setModel(this.oMdlEditRecord,"oMdlEditRecord");this.getView().byId("idIconTabBarInlineMode").getItems()[1].setText("Record Code : "+this.oMdlEditRecord.getData().EditRecord.UnitCode+" [EDIT]")})}this.recordCode=a;var d=this.getView().byId("idIconTabBarInlineMode");d.setSelectedKey("tab2");this.bIsAdd=false},onAdd:function(t){this.oMdlEditRecord.getData().EditRecord.Code="";this.oMdlEditRecord.getData().EditRecord.UnitCode="";this.oMdlEditRecord.getData().EditRecord.UnitDesc="";this.oMdlEditRecord.getData().EditRecord.LotNo="";this.oMdlEditRecord.getData().EditRecord.PhaseNo="";this.oMdlEditRecord.getData().EditRecord.BlockNo="";this.oMdlEditRecord.getData().EditRecord.FloorArea="";this.oMdlEditRecord.getData().EditRecord.BldTypeCode="";this.oMdlEditRecord.getData().EditRecord.PrprtyTypeCode="";this.oMdlEditRecord.getData().EditRecord.ProjectCode="";this.oMdlEditRecord.getData().EditRecord.UnitStatus="";this.oMdlEditRecord.refresh();this.getView().byId("idIconTabBarInlineMode").getItems()[1].setText("RECORD [ADD]");var e=this.getView().byId("idIconTabBarInlineMode");e.setSelectedKey("tab2");this.bIsAdd=true},onSelectGender:function(t){var e=t.getSource().getProperty("text");this.oMdlEditRecord.getData().EditRecord.Gender=e.toUpperCase()},onSave:function(t){this.oRecord={};this.oRecord.M_UNIT=[];this.dataObject={};this.resultAjaxCall=-1;if(this.bIsAdd){var e=s.generateUDTCode();var i="";$.ajax({url:"/rexsjs/public/rexsjs/ExecQuery.xsjs?dbName=APP_RE&procName=SPAPP_RE_GENERATEUNIT&"+"lotNumber="+this.oMdlEditRecord.getData().EditRecord.LotNo+"&phaseNumber="+this.oMdlEditRecord.getData().EditRecord.PhaseNo+"&blockNumber="+this.oMdlEditRecord.getData().EditRecord.BlockNo+"&projNumber="+this.oMdlEditRecord.getData().EditRecord.ProjectCode,type:"GET",async:false,xhrFields:{withCredentials:true},error:function(t,e,o){jQuery.sap.log.error("This should never have happened!")},success:function(t){i=t[0].Code},context:this}).done(function(t){if(t){i=t[0].Code;this.dataObject.O="I";this.dataObject.Code=e;this.dataObject.UnitCode=i;this.dataObject.UnitDesc=this.oMdlEditRecord.getData().EditRecord.UnitDesc;this.dataObject.LotNo=this.oMdlEditRecord.getData().EditRecord.LotNo;this.dataObject.PhaseNo=this.oMdlEditRecord.getData().EditRecord.PhaseNo;this.dataObject.BlockNo=this.oMdlEditRecord.getData().EditRecord.BlockNo;this.dataObject.FloorArea=this.oMdlEditRecord.getData().EditRecord.FloorArea;this.dataObject.BldTypeCode=this.oMdlEditRecord.getData().EditRecord.BldTypeCode;this.dataObject.PrprtyTypeCode=this.oMdlEditRecord.getData().EditRecord.PrprtyTypeCode;this.dataObject.ProjectCode=this.oMdlEditRecord.getData().EditRecord.ProjectCode;this.dataObject.UnitStatus=this.oMdlEditRecord.getData().EditRecord.UnitStatus;this.oRecord.M_UNIT.push(this.dataObject);this.resultAjaxCall=s.postData(this.oRecord);if(this.resultAjaxCall===0){o.show("Saved Successfully "+i)}else{o.show("Error")}}})}else{this.oRecord={};this.oRecord.M_UNIT=[];this.dataObject={};this.dataObject.O="U";this.dataObject.Code=this.oMdlEditRecord.getData().EditRecord.Code;this.dataObject.UnitDesc=this.oMdlEditRecord.getData().EditRecord.UnitDesc;this.dataObject.LotNo=this.oMdlEditRecord.getData().EditRecord.LotNo;this.dataObject.PhaseNo=this.oMdlEditRecord.getData().EditRecord.PhaseNo;this.dataObject.BlockNo=this.oMdlEditRecord.getData().EditRecord.BlockNo;this.dataObject.FloorArea=this.oMdlEditRecord.getData().EditRecord.FloorArea;this.dataObject.BldTypeCode=this.oMdlEditRecord.getData().EditRecord.BldTypeCode;this.dataObject.PrprtyTypeCode=this.oMdlEditRecord.getData().EditRecord.PrprtyTypeCode;this.dataObject.ProjectCode=this.oMdlEditRecord.getData().EditRecord.ProjectCode;this.dataObject.UnitStatus=this.oMdlEditRecord.getData().EditRecord.UnitStatus;this.oRecord.M_UNIT.push(this.dataObject);this.resultAjaxCall=s.postData(this.oRecord);if(this.resultAjaxCall===0){o.show("Successfully Updated "+this.oMdlEditRecord.getData().EditRecord.UnitCode)}else{o.show("Error")}}this.prepareTable(false)},filterGlobally:function(t){var e=t.getParameter("query");this._oGlobalFilter=null;if(e){this._oGlobalFilter=new i([new i("DocNum",a.Contains,e),new i("DocStatus",a.Contains,e),new i("CustomerCode",a.Contains,e),new i("FinanceScheme",a.Contains,e)],false)}this._filter()},_filter:function(){var t=null;if(this._oGlobalFilter){t=this._oGlobalFilter}this.byId(this.tableId).getBinding().filter(t,"Application")},clearAllFilters:function(t){var e=this.getView().byId(this.tableId);this._oGlobalFilter=null;this._filter();var o=e.getColumns();for(var i=0;i<o.length;i++){e.filter(o[i],null)}}})});